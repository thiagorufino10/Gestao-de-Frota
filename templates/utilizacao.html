{% extends "base.html" %}

{% block extra_head %}
<style>
  /* === Fundo igual ao index === */
  body{
    background:
      radial-gradient(1100px 560px at 8% -10%, rgba(43,108,176,.20), transparent 60%),
      radial-gradient(1000px 520px at 110% 110%, rgba(96,165,250,.16), transparent 60%),
      linear-gradient(135deg, #0b1220, #0f172a 60%, #0b1220);
  }

  :root{
    --rm-navy:#0F2C59;
    --rm-blue:#2B6CB0;
    --line:#E6EAF2;
    --muted:#475569;
  }

  .card-elev{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.08);
  }
  .card-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding-bottom:8px; border-bottom:1px solid var(--line);
  }
  .card-head h2{
    margin:0; font-weight:800; color:var(--rm-navy);
    display:flex; align-items:center; gap:.5rem;
    font-size:1.15rem;
  }
  .hint{ color:var(--muted); font-size:.9rem; }

  .form-grid{ display:grid; grid-template-columns: 1.2fr 1.2fr 1fr; gap:12px; }
  .form-grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

  .subhint{ font-size:.85rem; color:var(--muted); margin-top:.25rem; }

  .loading-dot{
    width:8px;height:8px;border-radius:50%;background:var(--rm-blue);
    display:inline-block; animation: pulse .9s infinite ease-in-out;
    vertical-align:middle; margin-left:.4rem;
  }
  @keyframes pulse{
    0%,100%{ transform:scale(0.9); opacity:.6; }
    50%{ transform:scale(1.1); opacity:1; }
  }

  @media (max-width: 992px){
    .form-grid, .form-grid-2{ grid-template-columns:1fr; }
  }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="card card-elev p-4">

      <div class="card-head mb-3">
        <h2><i class="bi bi-pencil-square"></i> Registro de Utilização</h2>
        <div class="hint">Selecione o veículo disponível e o condutor. A empresa e o KM serão sugeridos automaticamente.</div>
      </div>

      <form method="POST" id="formUtilizacao" autocomplete="off">
        <div class="form-grid mb-3">
          <div>
            <label for="usuario_id" class="form-label">Condutor</label>
            <select id="usuario_id" name="usuario_id" class="form-select" required>
              <option value="" selected disabled>Selecione...</option>
              {% for u in usuarios %}
                <option value="{{ u.id }}">{{ u.nome }} — {{ u.cargo }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="veiculo_id" class="form-label">Veículo (disponível) <span id="vehLoading" hidden class="loading-dot"></span></label>
            <select id="veiculo_id" name="veiculo_id" class="form-select" required>
              <option value="" selected disabled>Selecione...</option>
              {% for v in veiculos %}
                <option value="{{ v.id }}">{{ v.placa }} — {{ v.marca_modelo }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="data_entrega" class="form-label">Data de Entrega</label>
            <input type="date" id="data_entrega" name="data_entrega" class="form-control" required>
          </div>
        </div>

        <div class="form-grid-2 mb-3">
          <div>
            <label class="form-label">Empresa da Locação</label>
            <input type="text" class="form-control" id="empresa_nome" value="" placeholder="—" readonly>
            <input type="hidden" id="empresa_id" name="empresa_id" value="">
          </div>

          <div>
            <label for="km_entrega" class="form-label">KM de Entrega</label>
            <input type="number" inputmode="numeric" min="0" step="1" id="km_entrega" name="km_entrega" class="form-control" placeholder="0" required>
            <div class="subhint">Quando possível, sugerimos a última leitura conhecida.</div>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Voltar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2-square"></i> Registrar
          </button>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Preenche empresa e KM sugerido ao escolher veículo
  (function(){
    const selVeiculo = document.getElementById('veiculo_id');
    const empresaNome = document.getElementById('empresa_nome');
    const empresaId   = document.getElementById('empresa_id');
    const kmEntrega   = document.getElementById('km_entrega');
    const vehLoading  = document.getElementById('vehLoading');

    async function hydrateFromVeiculo(){
      const vid = selVeiculo.value;
      if(!vid){ 
        empresaNome.value=''; empresaId.value=''; kmEntrega.value='';
        return; 
      }

      try{
        vehLoading.hidden = false;
        const r = await fetch(`{{ url_for('get_veiculo_data', veiculo_id=0) }}`.replace('0', vid), { cache: 'no-store' });
        const data = await r.json();
        if(data && !data.error){
          empresaNome.value = data.empresa_nome || '';
          empresaId.value   = data.empresa_id   || '';
          if(typeof data.km_entrega_proximo !== 'undefined' && data.km_entrega_proximo !== null){
            kmEntrega.value = data.km_entrega_proximo;
          }
        }
      }catch(e){
        console.warn('Falha ao obter dados do veículo', e);
      }finally{
        vehLoading.hidden = true;
      }
    }

    selVeiculo?.addEventListener('change', hydrateFromVeiculo);

    // Preenche data de hoje por padrão
    const dt = document.getElementById('data_entrega');
    if(dt && !dt.value){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      dt.value = `${yyyy}-${mm}-${dd}`;
    }
  })();
</script>
{% endblock %}
