{% extends "base.html" %}

{% block extra_head %}
<style>
  /* === Fundo igual ao index === */
  body{
    background:
      radial-gradient(1100px 560px at 8% -10%, rgba(43,108,176,.20), transparent 60%),
      radial-gradient(1000px 520px at 110% 110%, rgba(96,165,250,.16), transparent 60%),
      linear-gradient(135deg, #0b1220, #0f172a 60%, #0b1220);
  }

  :root{
    --rm-navy:#0F2C59;
    --rm-blue:#2B6CB0;
    --line:#E6EAF2;
    --muted:#475569;
  }

  .card-elev{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.08);
  }

  .section-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding-bottom:8px; border-bottom:1px solid var(--line);
    margin-bottom:14px;
  }
  .section-head h2, .section-head h4{
    margin:0; font-weight:800; color:var(--rm-navy);
    display:flex; align-items:center; gap:.5rem;
  }
  .muted{ color:var(--muted); }

  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
  @media (max-width: 992px){
    .grid-2, .grid-3{ grid-template-columns:1fr; }
  }

  .helper{ font-size:.9rem; color:var(--muted); }
  .btn-soft{ background:#fff; border:1px solid var(--line); }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">

    {# Alerts flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- 1) REGISTRAR NOVA MULTA (TOPO) -->
    <div class="card-elev p-4 mb-4">
      <div class="section-head">
        <h2><i class="bi bi-exclamation-triangle-fill text-danger"></i> Registrar Nova Multa</h2>
        <span class="helper">Preencha os campos abaixo e salve.</span>
      </div>

      <form method="POST" id="form-nova-multa">
        <div class="grid-2 mb-3">
          <div>
            <label for="usuario_id" class="form-label">Condutor</label>
            <select id="usuario_id" name="usuario_id" class="form-select" required>
              <option value="" disabled selected>Selecione o Condutor</option>
              {% for usuario in usuarios %}
                <option value="{{ usuario.id }}" data-setor="{{ usuario.setor }}">{{ usuario.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="centro_custo" class="form-label">Centro de Custo</label>
            <input type="text" id="centro_custo" name="centro_custo" class="form-control" required readonly>
          </div>
        </div>

        <div class="grid-3 mb-3">
          <div>
            <label for="unidade" class="form-label">Unidade</label>
            <select id="unidade" name="unidade" class="form-select" required>
              <option value="" disabled selected>Selecione...</option>
              <option value="Matriz">Matriz</option>
              <option value="Bahia">Bahia</option>
              <option value="Fortaleza">Fortaleza</option>
              <option value="Paraíba">Paraíba</option>
              <option value="Teresina">Teresina</option>
            </select>
          </div>
          <div>
            <label for="modalidade" class="form-label">Modalidade</label>
            <select id="modalidade" name="modalidade" class="form-select" required>
              <option value="" disabled selected>Selecione...</option>
              <option value="Frota">Frota</option>
              <option value="Rent a Car">Rent a Car</option>
            </select>
          </div>
          <div>
            <label for="empresa_id" class="form-label">Empresa</label>
            <select id="empresa_id" name="empresa_id" class="form-select" required>
              <option value="" disabled selected>Selecione...</option>
              {% for empresa in empresas %}
                <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid-3 mb-3">
          <div>
            <label for="placa" class="form-label">Placa</label>
            <input type="text" id="placa" name="placa" class="form-control" required placeholder="ABC1D23" style="text-transform:uppercase;">
          </div>
          <div>
            <label for="mes_referencia_nome" class="form-label">Mês de Referência</label>
            <select id="mes_referencia_nome" name="mes_referencia_nome" class="form-select" required>
              <option value="" disabled selected>Selecione...</option>
              {% for mes in meses %}
                <option value="{{ mes }}">{{ mes }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="infracao" class="form-label">Infração</label>
            <input type="text" id="infracao" name="infracao" class="form-control" required>
          </div>
        </div>

        <div class="grid-3 mb-3">
          <div>
            <label for="data_infracao" class="form-label">Data da Infração</label>
            <input type="date" id="data_infracao" name="data_infracao" class="form-control" required>
          </div>
          <div>
            <label for="hora_infracao" class="form-label">Hora da Infração</label>
            <input type="time" id="hora_infracao" name="hora_infracao" class="form-control">
          </div>
          <div>
            <label for="valor_termo_desc" class="form-label">Valor Termo Desc.</label>
            <input type="number" id="valor_termo_desc" name="valor_termo_desc" class="form-control" step="0.01" min="0" required>
          </div>
        </div>

        <div class="grid-3 mb-4">
          <div>
            <label for="desconto_realizado" class="form-label">Desconto Realizado?</label>
            <select id="desconto_realizado" name="desconto_realizado" class="form-select" required>
              <option value="Sim">Sim</option>
              <option value="Não" selected>Não</option>
            </select>
          </div>
          <div>
            <label for="enviado_email_rh" class="form-label">Enviado e-mail ao RH?</label>
            <select id="enviado_email_rh" name="enviado_email_rh" class="form-select" required>
              <option value="Sim">Sim</option>
              <option value="Não" selected>Não</option>
            </select>
          </div>
          <div>
            <label for="observacao" class="form-label">Observação</label>
            <textarea id="observacao" name="observacao" class="form-control" rows="1" placeholder="Opcional"></textarea>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Voltar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save-fill"></i> Salvar Multa
          </button>
        </div>
      </form>
    </div>

    <!-- 2) GERENCIAMENTO DE MULTAS (ABAIXO) -->
    <div class="card-elev p-4">
      <div class="section-head">
        <h4><i class="bi bi-gear-wide-connected"></i> Gerenciamento de Multas</h4>
        <span class="helper">Consulte por condutor e importe planilhas.</span>
      </div>

      <div class="grid-2">
        <!-- Consultar por condutor -->
        <div>
          <label for="condutor_consulta" class="form-label">Condutor</label>
          <select id="condutor_consulta" name="usuario_id" class="form-select" required>
            <option value="" disabled selected>Selecione o Condutor</option>
            {% for usuario in usuarios %}
              <option value="{{ usuario.id }}">{{ usuario.nome }}</option>
            {% endfor %}
          </select>
          <div class="d-grid mt-2">
            <button id="btn-consultar" class="btn btn-primary">
              <i class="bi bi-search"></i> Consultar multas do condutor
            </button>
          </div>
        </div>

        <!-- Importar planilha -->
        <div>
          <p class="helper mb-2">
            Importar uma planilha (.xlsx/.csv) permite registrar várias multas de uma só vez.
          </p>
          <a href="{{ url_for('importar_multas') }}" class="btn btn-soft">
            <i class="bi bi-file-earmark-arrow-up"></i> Importar Planilha de Multas
          </a>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Botão "Consultar multas do condutor" -> redireciona
  document.getElementById('btn-consultar')?.addEventListener('click', function(){
    const sel = document.getElementById('condutor_consulta');
    if(sel && sel.value){
      // usa uma URL modelo válida e troca só o último segmento (id)
      const templateUrl = "{{ url_for('consultar_multas_por_condutor', usuario_id=0) }}";
      const base = templateUrl.substring(0, templateUrl.lastIndexOf('/') + 1);
      window.location.href = base + encodeURIComponent(sel.value);
    }else{
      alert('Selecione um condutor.');
    }
  });

  // Preenche Centro de Custo com o setor do condutor
  (function(){
    const condutor = document.getElementById('usuario_id');
    const cc = document.getElementById('centro_custo');
    condutor?.addEventListener('change', function(){
      const opt = condutor.options[condutor.selectedIndex];
      cc.value = opt?.getAttribute('data-setor') || '';
    });
  })();

  // Placa em maiúsculas e sem espaços extras
  (function(){
    const placa = document.getElementById('placa');
    placa?.addEventListener('input', function(){
      this.value = this.value.toUpperCase().replace(/\s+/g,'');
    });
  })();

  // Data da infração: hoje por padrão se vazio
  (function(){
    const di = document.getElementById('data_infracao');
    if(di && !di.value){
      const n = new Date();
      const yyyy = n.getFullYear();
      const mm = String(n.getMonth()+1).padStart(2,'0');
      const dd = String(n.getDate()).padStart(2,'0');
      di.value = `${yyyy}-${mm}-${dd}`;
    }
  })();
</script>
{% endblock %}
