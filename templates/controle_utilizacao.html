{% extends "base.html" %}

{% block extra_head %}
<style>
  /* === Fundo igual ao index === */
  body{
    background:
      radial-gradient(1100px 560px at 8% -10%, rgba(43,108,176,.20), transparent 60%),
      radial-gradient(1000px 520px at 110% 110%, rgba(96,165,250,.16), transparent 60%),
      linear-gradient(135deg, #0b1220, #0f172a 60%, #0b1220);
  }

  :root{
    --rm-navy:#0F2C59;
    --rm-blue:#2B6CB0;
    --sky:#60A5FA;
    --line:#E6EAF2;
    --muted:#475569;
  }

  .card-elev{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.08);
  }
  .head{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding-bottom:8px; border-bottom:1px solid var(--line);
  }
  .head h2{
    margin:0; font-weight:800; color:var(--rm-navy);
    display:flex; align-items:center; gap:.5rem;
    font-size:1.15rem;
  }
  .muted{ color:var(--muted); }

  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .pill{
    border:1px solid var(--line); background:#fff; color:#0b1220;
  }
  .pill.active{
    color:#fff; border-color: transparent;
    background: linear-gradient(135deg, var(--rm-blue), var(--sky));
  }
  .search-input{ max-width:300px; }

  .table thead th{ font-weight:700; color:#0F2C59; border-bottom:1px solid var(--line) !important; }
  .table tbody td{ vertical-align:middle; }

  .badge-soft{
    background: rgba(43,108,176,.1);
    color:#2B6CB0;
    border:1px solid rgba(43,108,176,.25);
    font-weight:700;
  }
  .status-badge{ font-weight:700; border:1px solid rgba(0,0,0,.08); }

  .actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
  .form-text-small{ font-size:.85rem; color:var(--muted); }
</style>
{% endblock %}

{% block content %}
{% set can_edit = (current_user.is_admin or current_user.can_edit) %}
{% set can_delete = (current_user.is_admin or current_user.can_delete) %}

<div class="row justify-content-center">
  <div class="col-12">
    <div class="card-elev p-4">

      <div class="head mb-3">
        <h2><i class="bi bi-list-task text-info"></i> Controle de Utilização</h2>
        <div class="muted">Acompanhe quem está com qual veículo, faça upload de checklists e gerencie devoluções.</div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div class="toolbar">
          <a href="{{ url_for('controle_utilizacao', filtro='em_uso') }}"
             class="btn btn-sm pill {% if filtro_atual=='em_uso' %}active{% endif %}">Em uso</a>
          <a href="{{ url_for('controle_utilizacao', filtro='devolvidos') }}"
             class="btn btn-sm pill {% if filtro_atual=='devolvidos' %}active{% endif %}">Devolvidos</a>
          <a href="{{ url_for('controle_utilizacao', filtro='todos') }}"
             class="btn btn-sm pill {% if filtro_atual=='todos' %}active{% endif %}">Todos</a>
        </div>

        <div class="toolbar">
          <span class="badge rounded-pill badge-soft">Total: {{ utilizacoes|length }}</span>
          <input id="filterInput" type="search" class="form-control form-control-sm search-input"
                 placeholder="Filtrar por veículo, placa, empresa ou usuário...">
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle" id="utilizacoesTable">
          <thead class="table-light">
            <tr>
              <th>Veículo</th>
              <th>Placa</th>
              <th>Empresa</th>
              <th>Usuário</th>
              <th>Entregue</th>
              <th>Devolução</th>
              <th>KM Entrega</th>
              <th>KM Devolução</th>
              <th>Status</th>
              <th class="text-end" style="width: 430px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for utilizacao in utilizacoes %}
            {% set qtd = ChecklistArquivo.query.filter_by(utilizacao_id=utilizacao.id).count() %}
            <tr>
              <td data-col="veic">{{ utilizacao.veiculo.marca_modelo }}</td>
              <td data-col="placa">{{ utilizacao.veiculo.placa }}</td>
              <td data-col="emp">{{ utilizacao.empresa.nome }}</td>
              <td data-col="user">{{ utilizacao.usuario.nome }}</td>
              <td>{{ utilizacao.data_entrega.strftime('%d/%m/%Y') }}</td>
              <td>{% if utilizacao.data_devolucao %}{{ utilizacao.data_devolucao.strftime('%d/%m/%Y') }}{% else %}-{% endif %}</td>
              <td>{{ utilizacao.km_entrega }}</td>
              <td>{% if utilizacao.km_devolucao is not none %}{{ utilizacao.km_devolucao }}{% else %}-{% endif %}</td>
              <td>
                {% if utilizacao.data_devolucao %}
                  <span class="badge text-bg-success status-badge">Devolvido</span>
                {% else %}
                  <span class="badge text-bg-danger status-badge">Em uso</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="actions">
                  {% if can_edit %}
                  <button class="btn btn-sm btn-outline-primary"
                          data-bs-toggle="modal" data-bs-target="#upModal-{{ utilizacao.id }}">
                    <i class="bi bi-upload"></i> Enviar PDF
                  </button>
                  {% else %}
                  <button class="btn btn-sm btn-outline-secondary" disabled title="Sem permissão">
                    <i class="bi bi-lock-fill"></i> Enviar PDF
                  </button>
                  {% endif %}

                  <button class="btn btn-sm btn-outline-dark"
                          data-bs-toggle="modal" data-bs-target="#listModal-{{ utilizacao.id }}">
                    <i class="bi bi-files"></i> Checklists
                    {% if qtd > 0 %}<span class="badge text-bg-secondary">{{ qtd }}</span>{% endif %}
                  </button>

                  {% if not utilizacao.data_devolucao %}
                    <a href="{{ url_for('controle_km_mensal', utilizacao_id=utilizacao.id) }}"
                       class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-speedometer"></i> KM Mensal
                    </a>
                    <a href="{{ url_for('consultar_multas_por_utilizacao', utilizacao_id=utilizacao.id) }}"
                       class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-exclamation-triangle"></i> Multas
                    </a>
                  {% endif %}

                  {% if not utilizacao.data_devolucao and can_edit %}
                    <!-- agora neutros (sem cor) e só colorem no hover via outline -->
                    <a href="{{ url_for('editar_utilizacao', id=utilizacao.id) }}" class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-pencil"></i> Editar
                    </a>
                    <a href="{{ url_for('devolucao', id=utilizacao.id) }}" class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-check-circle"></i> Devolver
                    </a>
                  {% endif %}

                  {% if can_delete %}
                  <form action="{{ url_for('excluir_utilizacao', id=utilizacao.id) }}" method="POST" class="d-inline"
                        onsubmit="return confirm('Tem certeza que deseja excluir esta utilização?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i> Excluir
                    </button>
                  </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 text-end">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left-circle"></i> Voltar
        </a>
      </div>
    </div>
  </div>
</div>

{# Modais fora da tabela (padrão do projeto) #}
{% for utilizacao in utilizacoes %}
  <!-- Modal: Upload PDF -->
  <div class="modal fade" id="upModal-{{ utilizacao.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form action="{{ url_for('upload_checklist', utilizacao_id=utilizacao.id) }}"
              method="POST" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-upload me-1"></i> Enviar checklist (PDF)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Arquivo PDF</label>
              <input type="file" name="arquivo" class="form-control" accept="application/pdf" required>
              <div class="form-text form-text-small">Tamanho máximo 20 MB. Somente PDF.</div>
            </div>
            <div class="small text-muted">
              <strong>Utilização:</strong> {{ utilizacao.veiculo.placa }} — {{ utilizacao.usuario.nome }}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-cloud-arrow-up"></i> Enviar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Lista de Checklists (a lista aparece SOMENTE aqui) -->
  <div class="modal fade" id="listModal-{{ utilizacao.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-files me-1"></i> Checklists — {{ utilizacao.veiculo.placa }} / {{ utilizacao.usuario.nome }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          {% set arquivos = ChecklistArquivo.query.filter_by(utilizacao_id=utilizacao.id).order_by(ChecklistArquivo.uploaded_at.desc()).all() %}
          {% if arquivos %}
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Enviado em</th>
                    <th>Tamanho</th>
                    <th class="text-end" style="width:180px;">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for arq in arquivos %}
                  <tr>
                    <td>{{ arq.nome_original }}</td>
                    <td>{{ arq.uploaded_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                      {% if arq.tamanho_bytes is not none %}
                        {{ (arq.tamanho_bytes/1024/1024)|round(2) }} MB
                      {% else %}—{% endif %}
                    </td>
                    <td class="text-end">
                      <a href="{{ url_for('download_checklist', arquivo_id=arq.id) }}"
                         class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Baixar
                      </a>
                      {% if can_delete %}
                      <form action="{{ url_for('excluir_checklist', arquivo_id=arq.id) }}"
                            method="POST" class="d-inline"
                            onsubmit="return confirm('Excluir este arquivo?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i> Excluir
                        </button>
                      </form>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info m-0"><i class="bi bi-info-circle"></i> Nenhum checklist enviado para esta utilização.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
{% endfor %}

{% endblock %}

{% block extra_scripts %}
<script>
  // Filtro rápido na tabela por veículo/placa/empresa/usuário
  (function(){
    const input = document.getElementById('filterInput');
    const rows  = () => Array.from(document.querySelectorAll('#utilizacoesTable tbody tr'));

    function txt(el, sel){ return (el.querySelector(sel)?.textContent || '').toLowerCase(); }

    input?.addEventListener('input', function(){
      const term = this.value.trim().toLowerCase();
      rows().forEach(tr => {
        if(!term){ tr.style.display=''; return; }
        const veic = txt(tr, '[data-col="veic"]');
        const placa= txt(tr, '[data-col="placa"]');
        const emp  = txt(tr, '[data-col="emp"]');
        const user = txt(tr, '[data-col="user"]');
        const ok = [veic, placa, emp, user].some(t => t.includes(term));
        tr.style.display = ok ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
