{% extends "base.html" %}

{% block extra_head %}
<style>
  /* Fundo no mesmo padrão das outras telas */
  body{
    background:
      radial-gradient(1100px 560px at 8% -10%, rgba(43,108,176,.20), transparent 60%),
      radial-gradient(1000px 520px at 110% 110%, rgba(96,165,250,.16), transparent 60%),
      linear-gradient(135deg, #0b1220, #0f172a 60%, #0b1220);
  }

  :root{
    --rm-navy:#0F2C59;
    --rm-blue:#2B6CB0;
    --line:#E6EAF2;
    --muted:#475569;
  }

  .card-elev{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.08);
  }

  .section-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding-bottom:8px; border-bottom:1px solid var(--line);
    margin-bottom:14px;
  }
  .section-head h2{
    margin:0; font-weight:800; color:var(--rm-navy);
    display:flex; align-items:center; gap:.5rem;
  }
  .helper{ color:var(--muted); }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--line); border-radius:999px; padding:.35rem .8rem;
    background:#fff; font-size:.95rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card-elev p-4">

      <div class="section-head">
        <h2><i class="bi bi-pencil-square text-warning"></i> Editar Multa</h2>
        <span class="helper">Atualize os dados da infração e salve as alterações.</span>
      </div>

      <!-- Contexto rápido -->
      <div class="d-flex flex-wrap gap-2 mb-3">
        <div class="pill"><i class="bi bi-person-badge"></i> <strong>Condutor:</strong> {{ multa.usuario.nome if multa.usuario else '-' }}</div>
        <div class="pill"><i class="bi bi-truck-front"></i> <strong>Placa:</strong> {{ multa.placa or '-' }}</div>
        <div class="pill"><i class="bi bi-buildings"></i> <strong>Empresa:</strong>
          {% set emp = (empresas|selectattr('id','equalto',multa.empresa_id)|list) %}
          {{ emp[0].nome if emp and emp[0] else '-' }}
        </div>
      </div>

      <form method="POST" class="row g-3">

        <div class="col-md-6">
          <label for="condutor" class="form-label">Condutor</label>
          <input type="text" id="condutor" class="form-control" value="{{ multa.usuario.nome if multa.usuario else '' }}" disabled>
        </div>

        <div class="col-md-6">
          <label for="centro_custo" class="form-label">Centro de Custo</label>
          <input type="text" id="centro_custo" name="centro_custo" class="form-control" value="{{ multa.centro_custo or '' }}" required>
        </div>

        <div class="col-md-6">
          <label for="unidade" class="form-label">Unidade</label>
          <select id="unidade" name="unidade" class="form-select" required>
            <option value="Matriz"    {% if multa.unidade == 'Matriz' %}selected{% endif %}>Matriz</option>
            <option value="Bahia"     {% if multa.unidade == 'Bahia' %}selected{% endif %}>Bahia</option>
            <option value="Fortaleza" {% if multa.unidade == 'Fortaleza' %}selected{% endif %}>Fortaleza</option>
            <option value="Paraíba"   {% if multa.unidade == 'Paraíba' %}selected{% endif %}>Paraíba</option>
            <option value="Teresina"  {% if multa.unidade == 'Teresina' %}selected{% endif %}>Teresina</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="modalidade" class="form-label">Modalidade</label>
          <select id="modalidade" name="modalidade" class="form-select" required>
            <option value="Frota"      {% if multa.modalidade == 'Frota' %}selected{% endif %}>Frota</option>
            <option value="Rent a Car" {% if multa.modalidade == 'Rent a Car' %}selected{% endif %}>Rent a Car</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="empresa_id" class="form-label">Empresa</label>
          <select id="empresa_id" name="empresa_id" class="form-select" required>
            {% for empresa in empresas %}
              <option value="{{ empresa.id }}" {% if empresa.id == multa.empresa_id %}selected{% endif %}>{{ empresa.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label for="placa" class="form-label">Placa</label>
          <input type="text" id="placa" name="placa" class="form-control" value="{{ multa.placa or '' }}" required>
        </div>

        <div class="col-md-6">
          <label for="mes_referencia_nome" class="form-label">Mês de Referência</label>
          {% set mes_atual = (multa.mes_referencia.split('-')[1]|int) if multa.mes_referencia else 0 %}
          <select id="mes_referencia_nome" name="mes_referencia_nome" class="form-select" required>
            {% for mes in meses %}
              <option value="{{ mes }}" {% if loop.index == mes_atual %}selected{% endif %}>{{ mes }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label for="infracao" class="form-label">Infração</label>
          <input type="text" id="infracao" name="infracao" class="form-control" value="{{ multa.infracao or '' }}" required>
        </div>

        <div class="col-md-6">
          <label for="data_infracao" class="form-label">Data da Infração</label>
          <input type="date" id="data_infracao" name="data_infracao" class="form-control"
                 value="{{ multa.data_infracao.strftime('%Y-%m-%d') if multa.data_infracao else '' }}" required>
        </div>

        <div class="col-md-6">
          <label for="hora_infracao" class="form-label">Hora da Infração</label>
          <input type="time" id="hora_infracao" name="hora_infracao" class="form-control" value="{{ multa.hora_infracao or '' }}">
        </div>

        <div class="col-md-6">
          <label for="valor_termo_desc" class="form-label">Valor Termo Desc.</label>
          <input type="number" id="valor_termo_desc" name="valor_termo_desc" class="form-control" step="0.01"
                 value="{{ multa.valor_termo_desc if multa.valor_termo_desc is not none else '' }}" required>
        </div>

        <div class="col-md-6">
          <label for="desconto_realizado" class="form-label">Desconto Realizado?</label>
          <select id="desconto_realizado" name="desconto_realizado" class="form-select" required>
            <option value="Sim" {% if multa.desconto_realizado == 'Sim' %}selected{% endif %}>Sim</option>
            <option value="Não" {% if multa.desconto_realizado == 'Não' %}selected{% endif %}>Não</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="enviado_email_rh" class="form-label">Enviado e-mail ao RH?</label>
          <select id="enviado_email_rh" name="enviado_email_rh" class="form-select" required>
            <option value="Sim" {% if multa.enviado_email_rh == 'Sim' %}selected{% endif %}>Sim</option>
            <option value="Não" {% if multa.enviado_email_rh == 'Não' %}selected{% endif %}>Não</option>
          </select>
        </div>

        <div class="col-12">
          <label for="observacao" class="form-label">Observação</label>
          <textarea id="observacao" name="observacao" class="form-control" rows="3">{{ multa.observacao or '' }}</textarea>
        </div>

        <div class="col-12 d-flex justify-content-between mt-2">
          <a href="{{ back_url or url_for('relatorio_multas') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-save-fill"></i> Salvar alterações
          </button>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Ajuste simples: padroniza a placa em maiúsculas
  (function(){
    const placa = document.getElementById('placa');
    if(placa){
      placa.addEventListener('input', () => placa.value = placa.value.toUpperCase());
    }
  })();
</script>
{% endblock %}
